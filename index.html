<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ghost of Tabor — Random Kit Picker</title>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; padding:20px; background:#0f1724; color:#e6eef8; }
  .container { max-width:900px; margin:0 auto; }
  h1 { margin:0 0 12px 0; }
  .grid { display:grid; grid-template-columns: 1fr 320px; gap:20px; align-items:start; }
  .panel { background:#0b1220; padding:14px; border-radius:8px; box-shadow: 0 6px 18px rgba(2,6,23,.6); }
  .toggles { display:flex; flex-direction:column; gap:10px; }
  .cat { border-bottom:1px solid rgba(255,255,255,.03); padding-bottom:10px; margin-bottom:10px; }
  label { display:flex; align-items:center; gap:10px; }
  button { margin-top:12px; padding:10px 14px; border-radius:8px; border: none; cursor:pointer; background:linear-gradient(180deg,#16a34a,#0d8a3b); color:#fff; font-weight:600; }
  img.preview { max-width:100%; display:block; margin-top:12px; border-radius:6px; }
  .small { font-size:0.9rem; color:#a8b3c8; }
  .link { color:#88ddff; text-decoration:underline; }
  .footer { margin-top:18px; color:#93a1b5; font-size:.9rem; }
</style>
</head>
<body>
  <div class="container">
    <h1>Ghost of Tabor — Random Kit Picker</h1>
    <p class="small">Uses a `manifest.json` file in your repo under <code>images/</code>. See instructions below to auto-generate the manifest.</p>

    <div class="grid">
      <div class="panel" id="left">
        <div id="controls">
          <div id="toggles" class="toggles"></div>
          <button id="generate">Generate</button>
          <div id="status" class="small" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="panel" id="right">
        <div id="result">
          <div id="summary" class="small"></div>
          <a id="filelink" href="#" target="_blank" class="link"></a>
          <img id="preview" class="preview" src="" alt="" />
        </div>
      </div>
    </div>

    <div class="footer panel" style="margin-top:16px;">
      <strong>Setup notes</strong>
      <ol>
        <li>Add a `manifest.json` at <code>images/manifest.json</code> (example format shown below).</li>
        <li>Commit everything and push to GitHub. The index will request the raw manifest via <code>raw.githubusercontent.com</code>.</li>
        <li>Alternatively, paste a manifest into the console below for quick testing.</li>
      </ol>

      <details>
        <summary>Manifest JSON example</summary>
        <pre style="white-space:pre-wrap; background:#081224; padding:8px; border-radius:6px; color:#9ecbff;">
{
  "Backpacks": {
    "Buyable": ["bp1.png", "bp2.png"],
    "FoundInRaid": ["bp_raid1.png"]
  },
  "Chestrigs": {
    "Buyable": ["ch1.png"]
  },
  "Helmets": {
    "BossDrops": ["h_boss1.png"]
  },
  "Weapons": {
    "Buyable": ["w1.png","w2.png"],
    "FoundInRaid": ["w_raid.png"]
  }
}
        </pre>
      </details>
    </div>
  </div>

<script>
(async function(){
  // ======= CONFIG =======
  const GITHUB_USER = "ke3g4n";
  const GITHUB_REPO = "GhostofTabor-Randomkit";
  const BRANCH = "main"; // change if your branch is different
  const MANIFEST_RAW_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/images/manifest.json`;

  // ======= Helpers and UI nodes =======
  const togglesDiv = document.getElementById('toggles');
  const generateBtn = document.getElementById('generate');
  const status = document.getElementById('status');
  const summary = document.getElementById('summary');
  const preview = document.getElementById('preview');
  const filelink = document.getElementById('filelink');

  let manifest = null;

  function setStatus(txt, isError=false){
    status.textContent = txt || "";
    status.style.color = isError ? "#ff9999" : "#9ecbff";
  }

  // fetch manifest
  async function loadManifest(){
    try{
      setStatus("Loading manifest...");
      const r = await fetch(MANIFEST_RAW_URL);
      if(!r.ok) throw new Error("Manifest not found (HTTP " + r.status + ")");
      manifest = await r.json();
      setStatus("Manifest loaded.");
      buildToggles();
    } catch (e) {
      setStatus("Error loading manifest: " + e.message, true);
      // leave manifest null
      togglesDiv.innerHTML = `<div class="small">Could not load manifest from:<br><code>${MANIFEST_RAW_URL}</code><br>Make sure the file exists and is committed to the repo.</div>`;
      console.error(e);
    }
  }

  // build toggles from manifest
  function buildToggles(){
    togglesDiv.innerHTML = "";
    for (const [category, subsections] of Object.entries(manifest)){
      const catEl = document.createElement('div');
      catEl.className = "cat";
      const title = document.createElement('div');
      title.innerHTML = `<strong>${category}</strong>`;
      catEl.appendChild(title);

      for (const sub of Object.keys(subsections)){
        const id = `chk_${category}_${sub}`.replace(/\s+/g,'_');
        const label = document.createElement('label');
        label.innerHTML = `
          <input type="checkbox" id="${id}" data-cat="${category}" data-sub="${sub}" checked>
          <span>${sub} <span style="color:#8ea9c4; font-size:.85rem">(${subsections[sub].length})</span></span>
        `;
        catEl.appendChild(label);
      }
      togglesDiv.appendChild(catEl);
    }
  }

  // pick random item
  function pickRandom(){
    const enabledSubs = [];
    const checks = togglesDiv.querySelectorAll('input[type=checkbox]');
    checks.forEach(ch => { if(ch.checked) enabledSubs.push({cat:ch.dataset.cat, sub:ch.dataset.sub}); });

    if(enabledSubs.length === 0){
      setStatus("No subsections selected. Please enable at least one toggle.", true);
      return null;
    }

    // Choose random category-sub pair, weighted by number of files
    // Build an array of choices that includes each file for weighting
    const weighted = [];
    for (const e of enabledSubs){
      const files = manifest[e.cat][e.sub] || [];
      for (const f of files){
        weighted.push({ cat: e.cat, sub: e.sub, file: f });
      }
    }
    if(weighted.length === 0){
      setStatus("No files available in enabled subsections.", true);
      return null;
    }

    const choice = weighted[Math.floor(Math.random() * weighted.length)];
    return choice;
  }

  // when generate clicked
  generateBtn.addEventListener('click', () => {
    const picked = pickRandom();
    if(!picked) return;
    const rawUrl = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/images/${encodeURIComponent(picked.cat)}/${encodeURIComponent(picked.sub)}/${encodeURIComponent(picked.file)}`;
    summary.textContent = `${picked.cat} / ${picked.sub} → ${picked.file}`;
    filelink.href = rawUrl;
    filelink.textContent = "Open raw file";
    preview.src = rawUrl;
    preview.alt = picked.file;
    setStatus("Generated one item.");
  });

  // try load manifest on page load
  await loadManifest();

  // Helpful dev note: you can paste a manifest object into console:
  // window.manifest = { ... }; buildToggles();
  window._debug = { MANIFEST_RAW_URL };
})();
</script>
</body>
</html>
